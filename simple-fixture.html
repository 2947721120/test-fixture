<script>
Polymer({
  is: 'simple-fixture',

  ready: function () {
    this.fixtureTemplates = this.lightDom.querySelectorAll('template');
  },

  create: function () {
    var generatedDoms = [];

    this.restore();

    this.lightDom.batch(function () {
      this.removeElements(this.fixtureTemplates);

      this.forElements(this.fixtureTemplates, function (fixtureTemplate) {
        generatedDoms.push(
          this.createFrom(fixtureTemplate)
        );
      }, this);
    });

    if (generatedDoms.length < 2) {
      return generatedDoms[0];
    }

    return generatedDoms;
  },

  createFrom: function (fixtureTemplate) {
    var fixturedFragment;
    var fixturedElements;
    var fixturedElement;

    if (!(fixtureTemplate &&
          fixtureTemplate instanceof HTMLTemplateElement)) {
      return;
    }

    fixturedFragment = document.importNode(fixtureTemplate.content, true)
    fixturedElements = [];
    fixturedElement = fixturedFragment.firstElementChild;

    while (fixturedElement) {
      fixturedElements.push(fixturedElement);
      fixturedElement = fixturedElement.nextElementSibling;
    }

    this.lightDom.appendChild(fixturedFragment);

    if (fixturedElements.length < 2) {
      return fixturedElements[0];
    }

    return fixturedElements;
  },

  restore: function () {
    this.lightDom.batch(function () {
      this.removeElements(this.lightDom.children());

      this.forElements(this.fixtureTemplates, function (fixtureTemplate) {
        this.lightDom.appendChild(fixtureTemplate);
      }, this);
    });

    this.generatedDomStack = [];
  },

  removeElements: function (elements) {
    this.forElements(elements, function (element) {
      this.lightDom.removeChild(element);
    }, this);
  },

  forElements: function (elements, iterator, context) {
    Array.prototype.slice.call(elements)
      .forEach(iterator, context);
  }
});
</script>
